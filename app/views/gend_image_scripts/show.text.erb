#!/bin/bash

set -eu
set -o pipefail

REQUEST_JSON=$(cat << EOS
<%= @json %>
EOS)

# To make an authenticated request add:
# --header "Authorization: Token token=\"<your API token>\""
CREATE_RESPONSE=$(
  echo "$REQUEST_JSON" | \
  curl \
    --data @- \
    --header 'Content-Type: application/json' \
    --header 'Accept: application/json' \
    <%= @endpoint %>
)

STATUS_URL=$(echo $CREATE_RESPONSE | jq --raw-output .status_url)

i=0
while true; do
  if [ "$i" -ge 10 ]; then exit 1; fi
  case $(curl --head --output /dev/null --write-out '%{http_code}' $STATUS_URL) in
    303) curl --location --remote-name --verbose $STATUS_URL; break;;
    200) sleep 3;;
    *) exit 1
  esac
  i=$(( $i + 1 ))
done
