{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Outputs": {
    "dbHost": {
      "Value": {
        "Fn::GetAtt": [
          "db",
          "Endpoint.Address"
        ]
      }
    }
  },
  "Parameters": {
    "canaryAmi": {
      "Type": "String"
    },
    "dbPassword": {
      "NoEcho": "TRUE",
      "Type": "String"
    },
    "dbUser": {
      "Type": "String"
    },
    "onDemandAmi": {
      "Type": "String"
    },
    "spotAmi": {
      "Type": "String"
    }
  },
  "Resources": {
    "assetRecordSetGroup": {
      "Properties": {
        "HostedZoneId": {
          "Ref": "memecaptainHostedZone"
        },
        "RecordSets": [
          {
            "AliasTarget": {
              "DNSName": {
                "Fn::GetAtt": [
                  "cloudFront",
                  "DomainName"
                ]
              },
              "HostedZoneId": "Z2FDTNDATAQYW2"
            },
            "Name": "a0.memecaptain.com.",
            "Type": "A"
          },
          {
            "AliasTarget": {
              "DNSName": {
                "Fn::GetAtt": [
                  "cloudFront",
                  "DomainName"
                ]
              },
              "HostedZoneId": "Z2FDTNDATAQYW2"
            },
            "Name": "a1.memecaptain.com.",
            "Type": "A"
          },
          {
            "AliasTarget": {
              "DNSName": {
                "Fn::GetAtt": [
                  "cloudFront",
                  "DomainName"
                ]
              },
              "HostedZoneId": "Z2FDTNDATAQYW2"
            },
            "Name": "a2.memecaptain.com.",
            "Type": "A"
          },
          {
            "AliasTarget": {
              "DNSName": {
                "Fn::GetAtt": [
                  "cloudFront",
                  "DomainName"
                ]
              },
              "HostedZoneId": "Z2FDTNDATAQYW2"
            },
            "Name": "i.memecaptain.com.",
            "Type": "A"
          },
          {
            "AliasTarget": {
              "DNSName": "s3-website-us-east-1.amazonaws.com",
              "HostedZoneId": "Z3AQBSTGFYJSTF"
            },
            "Name": "v1.memecaptain.com.",
            "Type": "A"
          }
        ]
      },
      "Type": "AWS::Route53::RecordSetGroup"
    },
    "autoScalingTopic": {
      "Properties": {
        "DisplayName": "autoscaling",
        "Subscription": [
          {
            "Endpoint": "matthewm@boedicker.org",
            "Protocol": "email"
          }
        ],
        "TopicName": "autoscaling"
      },
      "Type": "AWS::SNS::Topic"
    },
    "canaryAutoScalingGroup": {
      "Properties": {
        "DesiredCapacity": 1,
        "HealthCheckGracePeriod": 300,
        "HealthCheckType": "ELB",
        "LaunchConfigurationName": {
          "Ref": "canaryLaunchConfig"
        },
        "LoadBalancerNames": [
          {
            "Ref": "elb"
          }
        ],
        "MaxSize": 1,
        "MinSize": 1,
        "NotificationConfigurations": [
          {
            "NotificationTypes": [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN": {
              "Ref": "autoScalingTopic"
            }
          }
        ],
        "Tags": [
          {
            "Key": "pool",
            "PropagateAtLaunch": true,
            "Value": "canary"
          }
        ],
        "VPCZoneIdentifier": [
          {
            "Ref": "privateSubnet1"
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {}
      }
    },
    "canaryLaunchConfig": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "16"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "secretsInstanceProfile"
        },
        "ImageId": {
          "Ref": "canaryAmi"
        },
        "InstanceType": "t2.small",
        "KeyName": "memecaptain",
        "SecurityGroups": [
          {
            "Ref": "webSecurityGroup"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "set -e",
                "aws s3 cp s3://memecaptain-secrets/database.yml /database.yml",
                "aws s3 cp s3://memecaptain-secrets/env/small.env /env",
                ". /startup"
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "cloudFront": {
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            "a0.memecaptain.com",
            "a1.memecaptain.com",
            "a2.memecaptain.com",
            "i.memecaptain.com"
          ],
          "CustomErrorResponses": [
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 400
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 403
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 404
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 405
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 414
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 500
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 501
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 502
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 503
            },
            {
              "ErrorCachingMinTTL": 0,
              "ErrorCode": 504
            }
          ],
          "DefaultCacheBehavior": {
            "ForwardedValues": {
              "QueryString": false
            },
            "TargetOriginId": "memecaptain.com",
            "ViewerProtocolPolicy": "allow-all"
          },
          "Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::GetAtt": [
                "cloudFrontLogsBucket",
                "DomainName"
              ]
            }
          },
          "Origins": [
            {
              "CustomOriginConfig": {
                "OriginProtocolPolicy": "http-only"
              },
              "DomainName": "memecaptain.com",
              "Id": "memecaptain.com"
            }
          ],
          "ViewerCertificate": {
            "IamCertificateId": "ASCAIOVW54EYUMV3CHCMC",
            "SslSupportMethod": "sni-only"
          }
        }
      },
      "Type": "AWS::CloudFront::Distribution"
    },
    "cloudFrontLogsBucket": {
      "Properties": {
        "AccessControl": "Private",
        "BucketName": "memecaptain-cloudfront-logs"
      },
      "Type": "AWS::S3::Bucket"
    },
    "db": {
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AllocatedStorage": "100",
        "AvailabilityZone": "us-east-1d",
        "DBInstanceClass": "db.t2.small",
        "DBName": "memecaptain",
        "DBSubnetGroupName": {
          "Ref": "dbSubnetGroup"
        },
        "Engine": "postgres",
        "MasterUserPassword": {
          "Ref": "dbPassword"
        },
        "MasterUsername": {
          "Ref": "dbUser"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "memecaptain"
          }
        ],
        "VPCSecurityGroups": [
          {
            "Ref": "dbSecurityGroup"
          }
        ]
      },
      "Type": "AWS::RDS::DBInstance"
    },
    "dbSecurityGroup": {
      "Properties": {
        "GroupDescription": "db security group",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "1",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "5432",
            "IpProtocol": "tcp",
            "ToPort": "5432"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "db"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "dbSubnetGroup": {
      "Properties": {
        "DBSubnetGroupDescription": "db subnet group",
        "SubnetIds": [
          {
            "Ref": "privateSubnet1"
          },
          {
            "Ref": "privateSubnet2"
          }
        ]
      },
      "Type": "AWS::RDS::DBSubnetGroup"
    },
    "elb": {
      "DependsOn": "internetGatewayAttachment",
      "Properties": {
        "AccessLoggingPolicy": {
          "Enabled": true,
          "S3BucketName": {
            "Ref": "elbLogsBucket"
          }
        },
        "ConnectionDrainingPolicy": {
          "Enabled": true
        },
        "HealthCheck": {
          "HealthyThreshold": "4",
          "Interval": "30",
          "Target": "HTTP:80/",
          "Timeout": "5",
          "UnhealthyThreshold": "2"
        },
        "Listeners": [
          {
            "InstancePort": "80",
            "LoadBalancerPort": "80",
            "Protocol": "HTTP"
          },
          {
            "InstancePort": "80",
            "LoadBalancerPort": "443",
            "Protocol": "HTTPS",
            "SSLCertificateId": "arn:aws:iam::165945320610:server-certificate/memecaptain"
          }
        ],
        "LoadBalancerName": "memecaptain",
        "SecurityGroups": [
          {
            "Ref": "webSecurityGroup"
          }
        ],
        "Subnets": [
          {
            "Ref": "publicSubnet1"
          },
          {
            "Ref": "publicSubnet2"
          }
        ]
      },
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer"
    },
    "elbLogsBucket": {
      "Properties": {
        "AccessControl": "Private",
        "BucketName": "memecaptain-elb-logs"
      },
      "Type": "AWS::S3::Bucket"
    },
    "elbLogsBucketPolicy": {
      "Properties": {
        "Bucket": {
          "Ref": "elbLogsBucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Principal": {
                "AWS": [
                  "127311923021"
                ]
              },
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:s3:::",
                    {
                      "Ref": "elbLogsBucket"
                    },
                    "/AWSLogs/165945320610/*"
                  ]
                ]
              }
            }
          ]
        }
      },
      "Type": "AWS::S3::BucketPolicy"
    },
    "internetGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },
    "internetGatewayAttachment": {
      "Properties": {
        "InternetGatewayId": {
          "Ref": "internetGateway"
        },
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::VPCGatewayAttachment"
    },
    "internetGatewayRoute": {
      "DependsOn": "internetGatewayAttachment",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "internetGateway"
        },
        "RouteTableId": {
          "Ref": "internetGatewayRouteTable"
        }
      },
      "Type": "AWS::EC2::Route"
    },
    "internetGatewayRouteTable": {
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": "igw"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::RouteTable"
    },
    "memecaptainHostedZone": {
      "Properties": {
        "Name": "memecaptain.com"
      },
      "Type": "AWS::Route53::HostedZone"
    },
    "natInstance": {
      "DependsOn": "internetGatewayAttachment",
      "Properties": {
        "ImageId": "ami-184dc970",
        "InstanceType": "t2.micro",
        "KeyName": "memecaptain",
        "NetworkInterfaces": [
          {
            "AssociatePublicIpAddress": "true",
            "DeviceIndex": "0",
            "GroupSet": [
              {
                "Ref": "natSecurityGroup"
              }
            ],
            "SubnetId": {
              "Ref": "publicSubnet1"
            }
          }
        ],
        "SourceDestCheck": "false",
        "Tags": [
          {
            "Key": "Name",
            "Value": "nat"
          }
        ]
      },
      "Type": "AWS::EC2::Instance"
    },
    "natRoute": {
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "InstanceId": {
          "Ref": "natInstance"
        },
        "RouteTableId": {
          "Ref": "natRouteTable"
        }
      },
      "Type": "AWS::EC2::Route"
    },
    "natRouteTable": {
      "Properties": {
        "Tags": [
          {
            "Key": "Name",
            "Value": "nat"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::RouteTable"
    },
    "natSecurityGroup": {
      "Properties": {
        "GroupDescription": "nat security group",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "10.0.2.0/24",
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": "10.0.2.0/24",
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          },
          {
            "CidrIp": "10.0.3.0/24",
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": "10.0.3.0/24",
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "nat"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup"
    },
    "onDemandAutoScalingGroup": {
      "Properties": {
        "DesiredCapacity": 1,
        "HealthCheckGracePeriod": 300,
        "HealthCheckType": "ELB",
        "LaunchConfigurationName": {
          "Ref": "onDemandLaunchConfig"
        },
        "LoadBalancerNames": [
          {
            "Ref": "elb"
          }
        ],
        "MaxSize": 1,
        "MinSize": 1,
        "NotificationConfigurations": [
          {
            "NotificationTypes": [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN": {
              "Ref": "autoScalingTopic"
            }
          }
        ],
        "Tags": [
          {
            "Key": "pool",
            "PropagateAtLaunch": true,
            "Value": "ondemand"
          }
        ],
        "VPCZoneIdentifier": [
          {
            "Ref": "privateSubnet1"
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {}
      }
    },
    "onDemandLaunchConfig": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "16"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "secretsInstanceProfile"
        },
        "ImageId": {
          "Ref": "onDemandAmi"
        },
        "InstanceType": "t2.small",
        "KeyName": "memecaptain",
        "SecurityGroups": [
          {
            "Ref": "webSecurityGroup"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "set -e",
                "aws s3 cp s3://memecaptain-secrets/database.yml /database.yml",
                "aws s3 cp s3://memecaptain-secrets/env/small.env /env",
                ". /startup"
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "privateSubnet1": {
      "Properties": {
        "AvailabilityZone": "us-east-1d",
        "CidrBlock": "10.0.2.0/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "private1"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "privateSubnet1RouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Ref": "natRouteTable"
        },
        "SubnetId": {
          "Ref": "privateSubnet1"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "privateSubnet2": {
      "Properties": {
        "AvailabilityZone": "us-east-1e",
        "CidrBlock": "10.0.3.0/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "private2"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "privateSubnet2RouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Ref": "natRouteTable"
        },
        "SubnetId": {
          "Ref": "privateSubnet2"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "publicSubnet1": {
      "Properties": {
        "AvailabilityZone": "us-east-1d",
        "CidrBlock": "10.0.0.0/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "public1"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "publicSubnet1RouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Ref": "internetGatewayRouteTable"
        },
        "SubnetId": {
          "Ref": "publicSubnet1"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "publicSubnet2": {
      "Properties": {
        "AvailabilityZone": "us-east-1e",
        "CidrBlock": "10.0.1.0/24",
        "Tags": [
          {
            "Key": "Name",
            "Value": "public2"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "publicSubnet2RouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Ref": "internetGatewayRouteTable"
        },
        "SubnetId": {
          "Ref": "publicSubnet2"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "rootAlias": {
      "Properties": {
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "elb",
              "CanonicalHostedZoneName"
            ]
          },
          "HostedZoneId": {
            "Fn::GetAtt": [
              "elb",
              "CanonicalHostedZoneNameID"
            ]
          }
        },
        "HostedZoneId": {
          "Ref": "memecaptainHostedZone"
        },
        "Name": "memecaptain.com.",
        "Type": "A"
      },
      "Type": "AWS::Route53::RecordSet"
    },
    "secretsBucket": {
      "Properties": {
        "AccessControl": "Private",
        "BucketName": "memecaptain-secrets"
      },
      "Type": "AWS::S3::Bucket"
    },
    "secretsInstanceProfile": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "secretsRole"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "secretsRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Statement": [
                {
                  "Action": [
                    "s3:ListBucket"
                  ],
                  "Effect": "Allow",
                  "Resource": "arn:aws:s3:::memecaptain-secrets"
                },
                {
                  "Action": [
                    "s3:GetObject"
                  ],
                  "Effect": "Allow",
                  "Resource": "arn:aws:s3:::memecaptain-secrets/*"
                }
              ],
              "Version": "2012-10-17"
            },
            "PolicyName": "secretsPolicy"
          }
        ]
      },
      "Type": "AWS::IAM::Role"
    },
    "spot2ActivatePolicy": {
      "Properties": {
        "AdjustmentType": "ExactCapacity",
        "AutoScalingGroupName": {
          "Ref": "spot2AutoScalingGroup"
        },
        "ScalingAdjustment": "1"
      },
      "Type": "AWS::AutoScaling::ScalingPolicy"
    },
    "spot2AutoScalingGroup": {
      "Properties": {
        "DesiredCapacity": 0,
        "HealthCheckGracePeriod": 300,
        "HealthCheckType": "ELB",
        "LaunchConfigurationName": {
          "Ref": "spot2LaunchConfig"
        },
        "LoadBalancerNames": [
          {
            "Ref": "elb"
          }
        ],
        "MaxSize": 10,
        "MinSize": 0,
        "NotificationConfigurations": [
          {
            "NotificationTypes": [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN": {
              "Ref": "autoScalingTopic"
            }
          }
        ],
        "Tags": [
          {
            "Key": "pool",
            "PropagateAtLaunch": true,
            "Value": "spot2"
          }
        ],
        "VPCZoneIdentifier": [
          {
            "Ref": "privateSubnet1"
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {}
      }
    },
    "spot2CpuHighAlarm": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "spot2ScaleUpPolicy"
          }
        ],
        "AlarmDescription": "Scale up if CPU > 50% for 2 minutes",
        "AlarmName": "spot2CpuHigh",
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": {
              "Ref": "spot2AutoScalingGroup"
            }
          }
        ],
        "EvaluationPeriods": "2",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Period": "60",
        "Statistic": "Average",
        "Threshold": "50"
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "spot2DeactivatePolicy": {
      "Properties": {
        "AdjustmentType": "ExactCapacity",
        "AutoScalingGroupName": {
          "Ref": "spot2AutoScalingGroup"
        },
        "ScalingAdjustment": "0"
      },
      "Type": "AWS::AutoScaling::ScalingPolicy"
    },
    "spot2LaunchConfig": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "16"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "secretsInstanceProfile"
        },
        "ImageId": {
          "Ref": "spotAmi"
        },
        "InstanceType": "c4.large",
        "KeyName": "memecaptain",
        "SecurityGroups": [
          {
            "Ref": "webSecurityGroup"
          }
        ],
        "SpotPrice": "0.025",
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "set -e",
                "aws s3 cp s3://memecaptain-secrets/database.yml /database.yml",
                "aws s3 cp s3://memecaptain-secrets/env/large.env /env",
                ". /startup"
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "spot2ScaleUpPolicy": {
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": {
          "Ref": "spot2AutoScalingGroup"
        },
        "ScalingAdjustment": "1"
      },
      "Type": "AWS::AutoScaling::ScalingPolicy"
    },
    "spotAutoScalingGroup": {
      "Properties": {
        "DesiredCapacity": 1,
        "HealthCheckGracePeriod": 300,
        "HealthCheckType": "ELB",
        "LaunchConfigurationName": {
          "Ref": "spotLaunchConfig"
        },
        "LoadBalancerNames": [
          {
            "Ref": "elb"
          }
        ],
        "MaxSize": 10,
        "MetricsCollection": [
          {
            "Granularity": "1Minute",
            "Metrics": [
              "GroupInServiceInstances"
            ]
          }
        ],
        "MinSize": 1,
        "NotificationConfigurations": [
          {
            "NotificationTypes": [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN": {
              "Ref": "autoScalingTopic"
            }
          }
        ],
        "Tags": [
          {
            "Key": "pool",
            "PropagateAtLaunch": true,
            "Value": "spot"
          }
        ],
        "VPCZoneIdentifier": [
          {
            "Ref": "privateSubnet1"
          }
        ]
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {}
      }
    },
    "spotCpuHighAlarm": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "spotScaleUpPolicy"
          }
        ],
        "AlarmDescription": "Scale up if CPU > 50% for 2 minutes",
        "AlarmName": "spotCpuHigh",
        "ComparisonOperator": "GreaterThanThreshold",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": {
              "Ref": "spotAutoScalingGroup"
            }
          }
        ],
        "EvaluationPeriods": "2",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Period": "60",
        "Statistic": "Average",
        "Threshold": "50"
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "spotCpuLowAlarm": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "spotScaleDownPolicy"
          }
        ],
        "AlarmDescription": "Scale down if CPU < 5% for 50 minutes",
        "AlarmName": "spotCpuLow",
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": {
              "Ref": "spotAutoScalingGroup"
            }
          }
        ],
        "EvaluationPeriods": "50",
        "MetricName": "CPUUtilization",
        "Namespace": "AWS/EC2",
        "Period": "60",
        "Statistic": "Average",
        "Threshold": "5"
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "spotEmptyAlarm": {
      "Properties": {
        "AlarmActions": [
          {
            "Ref": "spot2ActivatePolicy"
          }
        ],
        "AlarmDescription": "spot auto scaling group has no in service instances",
        "AlarmName": "spotEmpty",
        "ComparisonOperator": "LessThanThreshold",
        "Dimensions": [
          {
            "Name": "AutoScalingGroupName",
            "Value": {
              "Ref": "spotAutoScalingGroup"
            }
          }
        ],
        "EvaluationPeriods": "1",
        "MetricName": "GroupInServiceInstances",
        "Namespace": "AWS/AutoScaling",
        "OKActions": [
          {
            "Ref": "spot2DeactivatePolicy"
          }
        ],
        "Period": "60",
        "Statistic": "Minimum",
        "Threshold": "1"
      },
      "Type": "AWS::CloudWatch::Alarm"
    },
    "spotLaunchConfig": {
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/xvda",
            "Ebs": {
              "VolumeSize": "16"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "secretsInstanceProfile"
        },
        "ImageId": {
          "Ref": "spotAmi"
        },
        "InstanceType": "m4.large",
        "KeyName": "memecaptain",
        "SecurityGroups": [
          {
            "Ref": "webSecurityGroup"
          }
        ],
        "SpotPrice": "0.03",
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "\n",
              [
                "#!/bin/bash",
                "set -e",
                "aws s3 cp s3://memecaptain-secrets/database.yml /database.yml",
                "aws s3 cp s3://memecaptain-secrets/env/large.env /env",
                ". /startup"
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    },
    "spotScaleDownPolicy": {
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": {
          "Ref": "spotAutoScalingGroup"
        },
        "ScalingAdjustment": "-1"
      },
      "Type": "AWS::AutoScaling::ScalingPolicy"
    },
    "spotScaleUpPolicy": {
      "Properties": {
        "AdjustmentType": "ChangeInCapacity",
        "AutoScalingGroupName": {
          "Ref": "spotAutoScalingGroup"
        },
        "ScalingAdjustment": "1"
      },
      "Type": "AWS::AutoScaling::ScalingPolicy"
    },
    "v1RedirectBucket": {
      "Properties": {
        "AccessControl": "PublicRead",
        "BucketName": "v1.memecaptain.com",
        "WebsiteConfiguration": {
          "RedirectAllRequestsTo": {
            "HostName": "memecaptain.com"
          }
        }
      },
      "Type": "AWS::S3::Bucket"
    },
    "vpc": {
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "Tags": [
          {
            "Key": "Name",
            "Value": "memecaptain"
          }
        ]
      },
      "Type": "AWS::EC2::VPC"
    },
    "webSecurityGroup": {
      "Properties": {
        "GroupDescription": "web security group",
        "SecurityGroupEgress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "1",
            "IpProtocol": "tcp",
            "ToPort": "65535"
          },
          {
            "CidrIp": "10.0.0.0/24",
            "FromPort": "8125",
            "IpProtocol": "udp",
            "ToPort": "8125"
          }
        ],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "80",
            "IpProtocol": "tcp",
            "ToPort": "80"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "FromPort": "443",
            "IpProtocol": "tcp",
            "ToPort": "443"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": "web"
          }
        ],
        "VpcId": {
          "Ref": "vpc"
        }
      },
      "Type": "AWS::EC2::SecurityGroup"
    }
  }
}
